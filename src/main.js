import { Telegraf, session } from 'telegraf';
import axios from 'axios'; // Ð”Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº DeepSeek API
import config from 'config'; // Ð”Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(config.get('TELEGRAM_TOKEN'));

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ middleware Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¹
bot.use(session());

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐµÑÑÐ¸Ð¸
const INITIAL_SESSION = {
  dialog: [], // ÐœÐ°ÑÑÐ¸Ð² Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°
  lastError: null, // ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°
};

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº DeepSeek API
async function getDeepSeekResponse(messages) {
  try {
    const response = await axios.post(
      'https://api.deepseek.com/v1/chat/completions', // Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸ URL API DeepSeek
      {
        model: 'deepseek-chat', // Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸ Ð¼Ð¾Ð´ÐµÐ»ÑŒ DeepSeek
        messages: messages,
      },
      {
        headers: {
          Authorization: `Bearer ${config.get('DEEPSEEK_API_KEY')}`, // API ÐºÐ»ÑŽÑ‡ DeepSeek
          'Content-Type': 'application/json',
        },
      }
    );

    // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    return response.data.choices[0].message.content;
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ Ðº DeepSeek:', error.response?.data || error.message);
    throw error; // ÐŸÑ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼ ÐºÐ¾Ð´Ðµ
  }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÐ¸
async function checkGrammar(userMessage) {
  const messages = [
    {
      role: 'system',
      content: 'Ð¢Ñ‹ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ ÑƒÐ¼Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚-Ð±Ð¾Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¸Ð·ÑƒÑ‡Ð°Ñ‚ÑŒ Ð¸Ñ‚Ð°Ð»ÑŒÑÐ½ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒ Ð¸Ñ… Ð¸ Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°.',
    },
    { role: 'user', content: `ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸: "${userMessage}"` },
  ];

  return await getDeepSeekResponse(messages);
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ð³Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°
async function generateQuestion() {
  const messages = [
    {
      role: 'system',
      content: 'Ð¢Ñ‹ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ ÑƒÐ¼Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚-Ð±Ð¾Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¸Ð·ÑƒÑ‡Ð°Ñ‚ÑŒ Ð¸Ñ‚Ð°Ð»ÑŒÑÐ½ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº. Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° Ð¸Ñ‚Ð°Ð»ÑŒÑÐ½ÑÐºÐ¾Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³.',
    },
    { role: 'user', content: 'Ð—Ð°Ð´Ð°Ð¹ Ð¼Ð½Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¸Ñ‚Ð°Ð»ÑŒÑÐ½ÑÐºÐ¾Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€.' },
  ];

  return await getDeepSeekResponse(messages);
}

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.command('start', async (ctx) => {
  ctx.session = INITIAL_SESSION; // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ
  await ctx.reply('ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð”Ð°Ð²Ð°Ð¹ Ð¿Ð¾Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÑƒÐµÐ¼ Ð¸Ñ‚Ð°Ð»ÑŒÑÐ½ÑÐºÐ¸Ð¹. ÐÐ°Ð¿Ð¸ÑˆÐ¸ Ñ‡Ñ‚Ð¾-Ð½Ð¸Ð±ÑƒÐ´ÑŒ, Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ñ Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÐ¾Ð¹ Ð¸ Ð·Ð°Ð´Ð°Ð¼ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹! ðŸ¤–');
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐµÑÑÐ¸Ð¸, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
  ctx.session ??= INITIAL_SESSION;

  const userMessage = ctx.message.text;
  console.log(`ðŸ’¬ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ ${ctx.message.from.username || ctx.message.from.id}: ${userMessage}`);

  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    const grammarCheckResponse = await checkGrammar(userMessage);

    // Ð•ÑÐ»Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    if (grammarCheckResponse.includes('ÐžÑˆÐ¸Ð±ÐºÐ°') || grammarCheckResponse.includes('Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ')) {
      await ctx.reply(`ðŸ” Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸:\n\n${grammarCheckResponse}`);
    } else {
      // Ð•ÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð½ÐµÑ‚
      await ctx.reply('âœ… ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐžÑˆÐ¸Ð±Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾. ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€!');
    }

    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ
    const question = await generateQuestion();

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°
    ctx.session.dialog.push({ role: 'assistant', content: question });

    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ°Ð¼Ð¾Ðµ ÑÑ‚Ð°Ñ€Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ 10 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    if (ctx.session.dialog.length > 10) {
      ctx.session.dialog.shift(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ°Ð¼Ð¾Ðµ ÑÑ‚Ð°Ñ€Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    }

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    await ctx.reply(question);
  } catch (e) {
    console.log('ðŸš¨ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', e.message);
    await ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
  }
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.launch();

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
